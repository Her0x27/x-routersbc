{{define "content"}}
<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    System Settings
                </h2>
            </div>
        </div>
    </div>
</div>
<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <!-- First login alert -->
        {{if .showFirstLoginAlert}}
        <div class="alert alert-warning alert-dismissible" role="alert">
            <div class="d-flex">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10.24 3.957l-8.422 14.06a1.989 1.989 0 0 0 1.7 2.983h16.845a1.989 1.989 0 0 0 1.7 -2.983l-8.423 -14.06a1.989 1.989 0 0 0 -3.4 0z"/>
                        <path d="M12 9v4"/>
                        <path d="M12 17h.01"/>
                    </svg>
                </div>
                <div>
                    <h4 class="alert-title">Security Notice</h4>
                    For security reasons, please change your default password immediately.
                    <div class="mt-2">
                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#password-modal">
                            Change Password
                        </button>
                    </div>
                </div>
            </div>
            <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        </div>
        {{end}}
        
        <div class="row row-deck row-cards">
            <!-- General Settings -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">General Settings</h3>
                    </div>
                    <div class="card-body">
                        <form id="general-settings-form">
                            <div class="mb-3">
                                <label class="form-label">Change Password</label>
                                <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#password-modal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <rect x="5" y="11" width="14" height="10" rx="2"/>
                                        <circle cx="12" cy="16" r="1"/>
                                        <path d="M8 11v-4a4 4 0 0 1 8 0v4"/>
                                    </svg>
                                    Change Password
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Time Zone</label>
                                <select class="form-select" name="timezone" id="timezone-select">
                                    <option value="">Loading timezones...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">NTP Server</label>
                                <input type="text" class="form-control" name="ntp_server" value="pool.ntp.org" placeholder="pool.ntp.org">
                                <small class="form-hint">Network Time Protocol server for automatic time synchronization</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="ntp_enabled" checked>
                                    <span class="form-check-label">Enable automatic time synchronization</span>
                                </label>
                            </div>
                            
                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- System Time -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Time</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Current Date & Time</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="current-time" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="syncTime()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                                    </svg>
                                    Sync
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">System Uptime</label>
                            <input type="text" class="form-control" id="system-uptime" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Last Boot</label>
                            <input type="text" class="form-control" id="last-boot" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Backup & Restore -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Backup & Restore</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Create Backup</label>
                            <p class="text-muted">Create a backup of system configuration including network settings, firewall rules, and user data.</p>
                            <button type="button" class="btn btn-outline-primary w-100" onclick="createBackup()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                    <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                                    <path d="M12 11v6"/>
                                    <path d="M9 14l3 -3l3 3"/>
                                </svg>
                                Create Backup
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Restore from Backup</label>
                            <p class="text-muted">Restore system configuration from a previously created backup file.</p>
                            <form id="restore-form" enctype="multipart/form-data">
                                <div class="input-group">
                                    <input type="file" class="form-control" name="backup" accept=".tar.gz,.tgz" required>
                                    <button class="btn btn-outline-danger" type="submit">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                                            <path d="M12 17v-6"/>
                                            <path d="M9 14l3 3l3 -3"/>
                                        </svg>
                                        Restore
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Information -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-2">
                                    <div class="text-muted">Hostname</div>
                                    <div id="hostname">Loading...</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    <div class="text-muted">Kernel</div>
                                    <div id="kernel">Loading...</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    <div class="text-muted">Load Average</div>
                                    <div id="load-average">Loading...</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    <div class="text-muted">Processes</div>
                                    <div id="processes">Loading...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="text-muted">Memory Usage</div>
                                <div id="memory-percent">0%</div>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="memory-bar" style="width: 0%" role="progressbar"></div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="text-muted">Disk Usage</div>
                                <div id="disk-percent">0%</div>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="disk-bar" style="width: 0%" role="progressbar"></div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="text-muted">Temperature</div>
                                <div id="temperature">-°C</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update current time every second
function updateTime() {
    const now = new Date();
    document.getElementById('current-time').value = now.toLocaleString();
}

// Load system status
function loadSystemStatus() {
    fetch('/system/status')
        .then(response => response.json())
        .then(data => {
            // Update system information
            document.getElementById('hostname').textContent = data.hostname || 'RouterSBC';
            document.getElementById('kernel').textContent = data.kernel || 'Linux';
            document.getElementById('load-average').textContent = data.load_average || '0.00 0.00 0.00';
            document.getElementById('processes').textContent = data.process_count || '0';
            
            // Update memory usage
            if (data.memory_usage !== undefined) {
                const memPercent = Math.round(data.memory_usage);
                document.getElementById('memory-percent').textContent = memPercent + '%';
                document.getElementById('memory-bar').style.width = memPercent + '%';
            }
            
            // Update disk usage
            if (data.disk_usage !== undefined) {
                const diskPercent = Math.round(data.disk_usage);
                document.getElementById('disk-percent').textContent = diskPercent + '%';
                document.getElementById('disk-bar').style.width = diskPercent + '%';
            }
            
            // Update temperature
            if (data.temperature !== undefined) {
                document.getElementById('temperature').textContent = Math.round(data.temperature) + '°C';
            }
            
            // Update uptime
            document.getElementById('system-uptime').value = data.uptime || 'Unknown';
            
            // Calculate last boot time
            if (data.uptime) {
                const uptimeSeconds = parseFloat(data.uptime.split(' ')[0]);
                const bootTime = new Date(Date.now() - (uptimeSeconds * 1000));
                document.getElementById('last-boot').value = bootTime.toLocaleString();
            }
        })
        .catch(error => {
            console.error('Error loading system status:', error);
        });
}

// Load timezone list
function loadTimezones() {
    const select = document.getElementById('timezone-select');
    const timezones = Intl.supportedValuesOf('timeZone');
    
    select.innerHTML = '';
    timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz;
        option.textContent = tz;
        select.appendChild(option);
    });
    
    // Set current timezone
    const currentTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    select.value = currentTz;
}

function syncTime() {
    fetch('/api/system/sync-time', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('Time synchronized successfully');
        }
    })
    .catch(error => alert('Error syncing time: ' + error));
}

function createBackup() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Creating...';
    
    fetch('/system/backup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            // Download the backup file
            const a = document.createElement('a');
            a.href = result.backupPath;
            a.download = result.backupPath.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert('Backup created successfully');
        }
    })
    .catch(error => alert('Error creating backup: ' + error))
    .finally(() => {
        button.disabled = false;
        button.innerHTML = 'Create Backup';
    });
}

// Handle general settings form
document.getElementById('general-settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.ntp_enabled = formData.get('ntp_enabled') === 'on';
    
    fetch('/api/system/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('Settings saved successfully');
        }
    })
    .catch(error => alert('Error saving settings: ' + error));
});

// Handle restore form
document.getElementById('restore-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirm('Are you sure you want to restore from backup? This will overwrite current settings.')) {
        return;
    }
    
    const formData = new FormData(this);
    
    fetch('/system/restore', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('Backup restored successfully. The system may need to restart.');
        }
    })
    .catch(error => alert('Error restoring backup: ' + error));
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateTime();
    loadSystemStatus();
    loadTimezones();
    
    // Update time every second
    setInterval(updateTime, 1000);
    
    // Update system status every 30 seconds
    setInterval(loadSystemStatus, 30000);
});
</script>
{{end}}
{{template "base/layout.html" .}}
