{{define "content"}}
<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/system">System</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Portable Devices</li>
                    </ol>
                </nav>
                <h2 class="page-title">
                    Portable Devices
                </h2>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshDevices()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="row row-deck row-cards">
            <!-- Device Detection Summary -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Device Detection Summary</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-sm-6 col-lg-2">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="bg-blue text-white stamp stamp-md me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 18l.01 0"/>
                                                    <path d="M9.172 15.172a4 4 0 0 1 5.656 0"/>
                                                    <path d="M6.343 12.343a8 8 0 0 1 11.314 0"/>
                                                    <path d="M3.515 9.515c4.686 -4.687 12.284 -4.687 17 0"/>
                                                </svg>
                                            </span>
                                            <div>
                                                <div class="h1 m-0" id="wifi-count">0</div>
                                                <div class="text-muted">WiFi</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-2">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="bg-green text-white stamp stamp-md me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <rect x="3" y="5" width="6" height="6" rx="1"/>
                                                    <rect x="15" y="15" width="6" height="6" rx="1"/>
                                                    <path d="m9 8l6 6"/>
                                                    <path d="m12 3l0 6"/>
                                                    <path d="m6 9l6 0"/>
                                                    <path d="m21 12l-6 0"/>
                                                    <path d="m18 15l0 6"/>
                                                </svg>
                                            </span>
                                            <div>
                                                <div class="h1 m-0" id="ethernet-count">0</div>
                                                <div class="text-muted">Ethernet</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-2">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="bg-purple text-white stamp stamp-md me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M7 12l5 5l10 -10"/>
                                                    <path d="M2 12l5 5m5 -5l5 -5"/>
                                                </svg>
                                            </span>
                                            <div>
                                                <div class="h1 m-0" id="bluetooth-count">0</div>
                                                <div class="text-muted">Bluetooth</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-2">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="bg-yellow text-white stamp stamp-md me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M6 9a6 6 0 1 0 12 0a6 6 0 0 0 -12 0"/>
                                                    <path d="M12 3c1.333 .333 2 2.333 2 6s-.667 5.667 -2 6"/>
                                                    <path d="M12 3c-1.333 .333 -2 2.333 -2 6s.667 5.667 2 6"/>
                                                    <path d="M6 9h12"/>
                                                    <path d="M3 20h7l-1 -1"/>
                                                    <path d="M21 20h-7l1 -1"/>
                                                </svg>
                                            </span>
                                            <div>
                                                <div class="h1 m-0" id="modem-count">0</div>
                                                <div class="text-muted">3G/LTE</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-2">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="bg-cyan text-white stamp stamp-md me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <rect x="4" y="6" width="16" height="12" rx="2"/>
                                                    <circle cx="9" cy="12" r="1"/>
                                                    <circle cx="15" cy="12" r="1"/>
                                                </svg>
                                            </span>
                                            <div>
                                                <div class="h1 m-0" id="storage-count">0</div>
                                                <div class="text-muted">Storage</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-2">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="bg-red text-white stamp stamp-md me-3">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M15 10l4.553 -2.276a1 1 0 0 1 1.447 .894v6.764a1 1 0 0 1 -1.447 .894l-4.553 -2.276v-4z"/>
                                                    <rect x="3" y="6" width="12" height="12" rx="2"/>
                                                </svg>
                                            </span>
                                            <div>
                                                <div class="h1 m-0" id="webcam-count">0</div>
                                                <div class="text-muted">Webcam</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Connected Devices -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Connected USB Devices</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-vcenter">
                                <thead>
                                    <tr>
                                        <th>Device</th>
                                        <th>Type</th>
                                        <th>Vendor ID</th>
                                        <th>Product ID</th>
                                        <th>Driver</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usb-devices">
                                    {{if .usbDevices}}
                                        {{range .usbDevices}}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">
                                                        {{if eq .Type "wifi"}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-blue" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <path d="M12 18l.01 0"/>
                                                                <path d="M9.172 15.172a4 4 0 0 1 5.656 0"/>
                                                                <path d="M6.343 12.343a8 8 0 0 1 11.314 0"/>
                                                                <path d="M3.515 9.515c4.686 -4.687 12.284 -4.687 17 0"/>
                                                            </svg>
                                                        {{else if eq .Type "ethernet"}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-green" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <rect x="3" y="5" width="6" height="6" rx="1"/>
                                                                <rect x="15" y="15" width="6" height="6" rx="1"/>
                                                                <path d="m9 8l6 6"/>
                                                                <path d="m12 3l0 6"/>
                                                                <path d="m6 9l6 0"/>
                                                                <path d="m21 12l-6 0"/>
                                                                <path d="m18 15l0 6"/>
                                                            </svg>
                                                        {{else if eq .Type "bluetooth"}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-purple" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <path d="M7 12l5 5l10 -10"/>
                                                                <path d="M2 12l5 5m5 -5l5 -5"/>
                                                            </svg>
                                                        {{else if eq .Type "modem"}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-yellow" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <path d="M6 9a6 6 0 1 0 12 0a6 6 0 0 0 -12 0"/>
                                                                <path d="M12 3c1.333 .333 2 2.333 2 6s-.667 5.667 -2 6"/>
                                                                <path d="M12 3c-1.333 .333 -2 2.333 -2 6s.667 5.667 2 6"/>
                                                                <path d="M6 9h12"/>
                                                                <path d="M3 20h7l-1 -1"/>
                                                                <path d="M21 20h-7l1 -1"/>
                                                            </svg>
                                                        {{else if eq .Type "storage"}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-cyan" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <rect x="4" y="6" width="16" height="12" rx="2"/>
                                                                <circle cx="9" cy="12" r="1"/>
                                                                <circle cx="15" cy="12" r="1"/>
                                                            </svg>
                                                        {{else if eq .Type "webcam"}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-red" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <path d="M15 10l4.553 -2.276a1 1 0 0 1 1.447 .894v6.764a1 1 0 0 1 -1.447 .894l-4.553 -2.276v-4z"/>
                                                                <rect x="3" y="6" width="12" height="12" rx="2"/>
                                                            </svg>
                                                        {{else}}
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon text-secondary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                <rect x="2" y="3" width="20" height="14" rx="2"/>
                                                                <line x1="8" y1="21" x2="16" y2="21"/>
                                                                <line x1="12" y1="17" x2="12" y2="21"/>
                                                            </svg>
                                                        {{end}}
                                                    </span>
                                                    <div>
                                                        <div class="fw-bold">{{.Name}}</div>
                                                        {{if .Description}}<div class="text-muted small">{{.Description}}</div>{{end}}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{if eq .Type "wifi"}}blue{{else if eq .Type "ethernet"}}green{{else if eq .Type "bluetooth"}}purple{{else if eq .Type "modem"}}yellow{{else if eq .Type "storage"}}cyan{{else if eq .Type "webcam"}}red{{else}}secondary{{end}}">
                                                    {{.Type}}
                                                </span>
                                            </td>
                                            <td><code>{{.VendorID}}</code></td>
                                            <td><code>{{.ProductID}}</code></td>
                                            <td>
                                                {{if eq .Driver "unknown"}}
                                                    <span class="text-muted">{{.Driver}}</span>
                                                {{else}}
                                                    <span class="badge bg-green">{{.Driver}}</span>
                                                {{end}}
                                            </td>
                                            <td>
                                                {{if eq .Status "connected"}}
                                                    <span class="status status-green">
                                                        <span class="status-dot status-dot-animated"></span>
                                                        Connected
                                                    </span>
                                                {{else if eq .Status "error"}}
                                                    <span class="status status-red">
                                                        <span class="status-dot"></span>
                                                        Error
                                                    </span>
                                                {{else}}
                                                    <span class="status status-gray">
                                                        <span class="status-dot"></span>
                                                        {{.Status}}
                                                    </span>
                                                {{end}}
                                            </td>
                                            <td>
                                                <div class="btn-list flex-nowrap">
                                                    {{if eq .Driver "unknown"}}
                                                    <button class="btn btn-outline-primary btn-sm" onclick="installDriver('{{.VendorID}}', '{{.ProductID}}')">
                                                        Install Driver
                                                    </button>
                                                    {{end}}
                                                    <button class="btn btn-outline-secondary btn-sm" onclick="showDeviceInfo('{{.ID}}')">
                                                        Info
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {{end}}
                                    {{else}}
                                    <tr id="no-devices-row">
                                        <td colspan="7" class="text-center text-muted">No USB devices detected</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Driver Installation Guide -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Driver Installation Guide</h3>
                    </div>
                    <div class="card-body">
                        <div class="steps">
                            <div class="step-item">
                                <div class="h4">1. Automatic Installation</div>
                                <div class="text-muted">Click "Install Driver" for automatic driver detection and installation.</div>
                            </div>
                            <div class="step-item">
                                <div class="h4">2. Manual Installation</div>
                                <div class="text-muted">Use the device vendor ID and product ID to manually search for drivers.</div>
                            </div>
                            <div class="step-item">
                                <div class="h4">3. System Reboot</div>
                                <div class="text-muted">Some drivers may require a system reboot to take effect.</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="checkSystemUpdates()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                                </svg>
                                Check for System Updates
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Device Status Monitor -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Device Status Monitor</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <div class="text-muted">Working Devices</div>
                                    <div class="h2 text-green" id="working-devices">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <div class="text-muted">Driver Issues</div>
                                    <div class="h2 text-red" id="driver-issues">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="text-muted mb-2">Device Health</div>
                            <div class="progress">
                                <div class="progress-bar bg-green" id="device-health-bar" style="width: 100%" role="progressbar"></div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted">Last Scan</div>
                                <div id="last-scan">Never</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Info Modal -->
<div class="modal modal-blur fade" id="device-info-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Device Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="device-info-content">
                <!-- Device details will be loaded here -->
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Close</a>
            </div>
        </div>
    </div>
</div>

<script>
function refreshDevices() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Scanning...';
    
    fetch('/api/system/usb-devices/refresh', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            loadUSBDevices();
            updateLastScan();
        }
    })
    .catch(error => {
        console.error('Error refreshing devices:', error);
        alert('Error refreshing devices: ' + error);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>Refresh';
    });
}

function loadUSBDevices() {
    fetch('/api/system/usb-devices')
        .then(response => response.json())
        .then(devices => {
            updateDeviceCounts(devices);
            updateDeviceTable(devices);
            updateDeviceHealth(devices);
        })
        .catch(error => {
            console.error('Error loading USB devices:', error);
        });
}

function updateDeviceCounts(devices) {
    const counts = {
        wifi: 0,
        ethernet: 0,
        bluetooth: 0,
        modem: 0,
        storage: 0,
        webcam: 0
    };
    
    devices.forEach(device => {
        if (counts.hasOwnProperty(device.type)) {
            counts[device.type]++;
        }
    });
    
    document.getElementById('wifi-count').textContent = counts.wifi;
    document.getElementById('ethernet-count').textContent = counts.ethernet;
    document.getElementById('bluetooth-count').textContent = counts.bluetooth;
    document.getElementById('modem-count').textContent = counts.modem;
    document.getElementById('storage-count').textContent = counts.storage;
    document.getElementById('webcam-count').textContent = counts.webcam;
}

function updateDeviceTable(devices) {
    const tbody = document.getElementById('usb-devices');
    const noDevicesRow = document.getElementById('no-devices-row');
    
    // Remove existing device rows but keep the no-devices row
    const rows = tbody.querySelectorAll('tr:not(#no-devices-row)');
    rows.forEach(row => row.remove());
    
    if (devices.length === 0) {
        if (noDevicesRow) {
            noDevicesRow.style.display = '';
        }
        return;
    }
    
    if (noDevicesRow) {
        noDevicesRow.style.display = 'none';
    }
    
    devices.forEach(device => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <span class="me-2">${getDeviceIcon(device.type)}</span>
                    <div>
                        <div class="fw-bold">${device.name}</div>
                        ${device.description ? `<div class="text-muted small">${device.description}</div>` : ''}
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-${getDeviceColor(device.type)}">${device.type}</span>
            </td>
            <td><code>${device.vendor_id}</code></td>
            <td><code>${device.product_id}</code></td>
            <td>
                ${device.driver === 'unknown' ? 
                    `<span class="text-muted">${device.driver}</span>` :
                    `<span class="badge bg-green">${device.driver}</span>`
                }
            </td>
            <td>${getStatusBadge(device.status)}</td>
            <td>
                <div class="btn-list flex-nowrap">
                    ${device.driver === 'unknown' ? 
                        `<button class="btn btn-outline-primary btn-sm" onclick="installDriver('${device.vendor_id}', '${device.product_id}')">Install Driver</button>` : 
                        ''
                    }
                    <button class="btn btn-outline-secondary btn-sm" onclick="showDeviceInfo('${device.id}')">Info</button>
                </div>
            </td>
        `;
    });
}

function updateDeviceHealth(devices) {
    const workingDevices = devices.filter(d => d.status === 'connected' && d.driver !== 'unknown').length;
    const driverIssues = devices.filter(d => d.driver === 'unknown' || d.status === 'error').length;
    const totalDevices = devices.length;
    
    document.getElementById('working-devices').textContent = workingDevices;
    document.getElementById('driver-issues').textContent = driverIssues;
    
    const healthPercentage = totalDevices > 0 ? (workingDevices / totalDevices) * 100 : 100;
    document.getElementById('device-health-bar').style.width = healthPercentage + '%';
    
    // Change color based on health
    const healthBar = document.getElementById('device-health-bar');
    healthBar.className = 'progress-bar';
    if (healthPercentage >= 80) {
        healthBar.classList.add('bg-green');
    } else if (healthPercentage >= 60) {
        healthBar.classList.add('bg-yellow');
    } else {
        healthBar.classList.add('bg-red');
    }
}

function getDeviceIcon(type) {
    const icons = {
        wifi: '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-blue" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 18l.01 0"/><path d="M9.172 15.172a4 4 0 0 1 5.656 0"/><path d="M6.343 12.343a8 8 0 0 1 11.314 0"/><path d="M3.515 9.515c4.686 -4.687 12.284 -4.687 17 0"/></svg>',
        ethernet: '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-green" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="6" height="6" rx="1"/><rect x="15" y="15" width="6" height="6" rx="1"/><path d="m9 8l6 6"/><path d="m12 3l0 6"/><path d="m6 9l6 0"/><path d="m21 12l-6 0"/><path d="m18 15l0 6"/></svg>',
        bluetooth: '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-purple" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 12l5 5l10 -10"/><path d="M2 12l5 5m5 -5l5 -5"/></svg>',
        modem: '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-yellow" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9a6 6 0 1 0 12 0a6 6 0 0 0 -12 0"/><path d="M12 3c1.333 .333 2 2.333 2 6s-.667 5.667 -2 6"/><path d="M12 3c-1.333 .333 -2 2.333 -2 6s.667 5.667 2 6"/><path d="M6 9h12"/><path d="M3 20h7l-1 -1"/><path d="M21 20h-7l1 -1"/></svg>',
        storage: '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-cyan" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="6" width="16" height="12" rx="2"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/></svg>',
        webcam: '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-red" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l4.553 -2.276a1 1 0 0 1 1.447 .894v6.764a1 1 0 0 1 -1.447 .894l-4.553 -2.276v-4z"/><rect x="3" y="6" width="12" height="12" rx="2"/></svg>'
    };
    return icons[type] || '<svg xmlns="http://www.w3.org/2000/svg" class="icon text-secondary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>';
}

function getDeviceColor(type) {
    const colors = {
        wifi: 'blue',
        ethernet: 'green',
        bluetooth: 'purple',
        modem: 'yellow',
        storage: 'cyan',
        webcam: 'red'
    };
    return colors[type] || 'secondary';
}

function getStatusBadge(status) {
    switch (status) {
        case 'connected':
            return '<span class="status status-green"><span class="status-dot status-dot-animated"></span>Connected</span>';
        case 'error':
            return '<span class="status status-red"><span class="status-dot"></span>Error</span>';
        default:
            return '<span class="status status-gray"><span class="status-dot"></span>' + status + '</span>';
    }
}

function installDriver(vendorId, productId) {
    if (confirm(`Install driver for device ${vendorId}:${productId}?`)) {
        fetch('/api/system/install-driver', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vendor_id: vendorId, product_id: productId })
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                alert('Driver installation initiated. Please check system logs for progress.');
                loadUSBDevices();
            }
        })
        .catch(error => alert('Error installing driver: ' + error));
    }
}

function showDeviceInfo(deviceId) {
    fetch(`/api/system/usb-devices/${deviceId}`)
        .then(response => response.json())
        .then(device => {
            const content = document.getElementById('device-info-content');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>Device Details</h4>
                        <table class="table table-sm">
                            <tr><td>Name</td><td>${device.name}</td></tr>
                            <tr><td>Type</td><td><span class="badge bg-${getDeviceColor(device.type)}">${device.type}</span></td></tr>
                            <tr><td>Vendor ID</td><td><code>${device.vendor_id}</code></td></tr>
                            <tr><td>Product ID</td><td><code>${device.product_id}</code></td></tr>
                            <tr><td>Driver</td><td>${device.driver}</td></tr>
                            <tr><td>Status</td><td>${getStatusBadge(device.status)}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Description</h4>
                        <p>${device.description || 'No description available'}</p>
                        ${device.driver === 'unknown' ? `
                        <div class="alert alert-warning">
                            <h4 class="alert-title">Driver Not Found</h4>
                            <div class="text-muted">This device requires a driver to function properly. Try installing drivers automatically or check the manufacturer's website.</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('device-info-modal'));
            modal.show();
        })
        .catch(error => {
            alert('Error loading device info: ' + error);
        });
}

function checkSystemUpdates() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Checking...';
    
    fetch('/api/system/check-updates', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert(`System check complete. ${result.updates_available || 0} updates available.`);
        }
    })
    .catch(error => alert('Error checking updates: ' + error))
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>Check for System Updates';
    });
}

function updateLastScan() {
    document.getElementById('last-scan').textContent = new Date().toLocaleTimeString();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadUSBDevices();
    updateLastScan();
    
    // Auto-refresh every 30 seconds
    setInterval(loadUSBDevices, 30000);
});
</script>
{{end}}
{{template "base/layout.html" .}}
