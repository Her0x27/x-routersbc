<!-- NFTables Firewall Configuration -->
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
            <li class="nav-item">
                <a href="#tabs-general-rules" class="nav-link active" data-bs-toggle="tab">General Rules</a>
            </li>
            <li class="nav-item">
                <a href="#tabs-chains" class="nav-link" data-bs-toggle="tab">Tables & Chains</a>
            </li>
            <li class="nav-item">
                <a href="#tabs-nat" class="nav-link" data-bs-toggle="tab">NAT Rules</a>
            </li>
            <li class="nav-item">
                <a href="#tabs-templates" class="nav-link" data-bs-toggle="tab">Rule Templates</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content">
            <!-- General Rules -->
            <div class="tab-pane active show" id="tabs-general-rules">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>NFTables Rules</h4>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#firewallModal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Rule
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-vcenter">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Table</th>
                                <th>Chain</th>
                                <th>Rule</th>
                                <th>Status</th>
                                <th class="w-1">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nftablesRulesTable">
                            {{range .FirewallConfig.Rules}}
                            <tr>
                                <td><span class="badge bg-blue">{{.Position}}</span></td>
                                <td>{{if contains .Chain ":"}}{{index (split .Chain ":") 0}}{{else}}inet{{end}}</td>
                                <td>{{if contains .Chain ":"}}{{index (split .Chain ":") 1}}{{else}}{{.Chain}}{{end}}</td>
                                <td><code>{{.RuleText}}</code></td>
                                <td>
                                    {{if .Enabled}}
                                    <span class="badge bg-success">Active</span>
                                    {{else}}
                                    <span class="badge bg-secondary">Disabled</span>
                                    {{end}}
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <a href="#" class="btn btn-sm btn-outline-primary" onclick="editFirewallRule({{.ID}})">Edit</a>
                                        <a href="#" class="btn btn-sm btn-outline-danger" onclick="deleteFirewallRule({{.ID}})">Delete</a>
                                    </div>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="6" class="text-center text-muted">No rules configured</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tables & Chains -->
            <div class="tab-pane" id="tabs-chains">
                <div class="row">
                    <div class="col-lg-6">
                        <h4>Available Tables</h4>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <strong>inet filter</strong>
                                        <div class="text-muted">Main filtering table for IPv4/IPv6</div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <strong>inet nat</strong>
                                        <div class="text-muted">Network Address Translation</div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <strong>inet mangle</strong>
                                        <div class="text-muted">Packet modification</div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-secondary">Inactive</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h4>Filter Chains</h4>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Chain</th>
                                        <th>Hook</th>
                                        <th>Priority</th>
                                        <th>Policy</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>input</code></td>
                                        <td>input</td>
                                        <td>0</td>
                                        <td><span class="badge bg-green">accept</span></td>
                                    </tr>
                                    <tr>
                                        <td><code>forward</code></td>
                                        <td>forward</td>
                                        <td>0</td>
                                        <td><span class="badge bg-green">accept</span></td>
                                    </tr>
                                    <tr>
                                        <td><code>output</code></td>
                                        <td>output</td>
                                        <td>0</td>
                                        <td><span class="badge bg-green">accept</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h4>Create Custom Chain</h4>
                    <form id="createChainForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Table</label>
                            <select class="form-select" name="table" required>
                                <option value="">Select table...</option>
                                <option value="inet filter">inet filter</option>
                                <option value="inet nat">inet nat</option>
                                <option value="inet mangle">inet mangle</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Chain Name</label>
                            <input type="text" class="form-control" name="chain_name" placeholder="custom_chain" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="chain_type">
                                <option value="">Regular chain</option>
                                <option value="filter">Base filter chain</option>
                                <option value="nat">Base NAT chain</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Create Chain</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- NAT Rules -->
            <div class="tab-pane" id="tabs-nat">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>NAT Rules</h4>
                    <button type="button" class="btn btn-primary" onclick="addNATRule()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add NAT Rule
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-vcenter">
                        <thead>
                            <tr>
                                <th>Chain</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Interface</th>
                                <th>Action</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th class="w-1">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="natRulesTable">
                            <tr>
                                <td><code>postrouting</code></td>
                                <td>192.168.1.0/24</td>
                                <td>any</td>
                                <td>eth0</td>
                                <td><span class="badge bg-info">masquerade</span></td>
                                <td>-</td>
                                <td><span class="badge bg-success">Active</span></td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <a href="#" class="btn btn-sm btn-outline-primary">Edit</a>
                                        <a href="#" class="btn btn-sm btn-outline-danger">Delete</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rule Templates -->
            <div class="tab-pane" id="tabs-templates">
                <h4>Quick Rule Templates</h4>
                <div class="row row-cards">
                    <div class="col-sm-6 col-lg-4">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-success text-white avatar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M9 12l2 2l4 -4"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">Allow SSH</div>
                                        <div class="text-muted">Allow incoming SSH connections</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-success btn-sm w-100" onclick="applyTemplate('allow_ssh')">Apply Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-success text-white avatar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M9 12l2 2l4 -4"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">Allow HTTP/HTTPS</div>
                                        <div class="text-muted">Allow web server traffic</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-success btn-sm w-100" onclick="applyTemplate('allow_web')">Apply Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-info text-white avatar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M7 10l5 -6l5 6"/>
                                                <path d="M21 10l-2 8a2 2.5 0 0 1 -2 2h-10a2 2.5 0 0 1 -2 -2l-2 -8z"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">NAT Masquerade</div>
                                        <div class="text-muted">Enable internet sharing</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-info btn-sm w-100" onclick="applyTemplate('nat_masquerade')">Apply Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-danger text-white avatar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <circle cx="12" cy="12" r="9"/>
                                                <path d="M5.7 5.7l12.6 12.6"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">Block All</div>
                                        <div class="text-muted">Block all incoming traffic</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-danger btn-sm w-100" onclick="applyTemplate('block_all')">Apply Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function editFirewallRule(id) {
    fetch(`/network/api/firewall/rules/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Error', data.error, 'danger');
                return;
            }
            
            // Populate modal with rule data
            const form = document.getElementById('firewallForm');
            form.elements.name.value = data.name || '';
            form.elements.chain.value = data.chain || '';
            form.elements.rule_text.value = data.rule_text || '';
            form.elements.position.value = data.position || 0;
            form.elements.enabled.checked = data.enabled || false;
            
            // Set form for update
            form.setAttribute('data-action', 'update');
            form.setAttribute('data-id', id);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('firewallModal'));
            modal.show();
        })
        .catch(error => {
            showAlert('Error', 'Failed to load rule data', 'danger');
            console.error('Error:', error);
        });
}

function deleteFirewallRule(id) {
    if (!confirm('Are you sure you want to delete this firewall rule?')) {
        return;
    }
    
    fetch(`/network/api/firewall/rules/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', 'Firewall rule deleted successfully', 'success');
            refreshFirewallRules();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to delete firewall rule', 'danger');
        console.error('Error:', error);
    });
}

function addNATRule() {
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('genericModal'));
    
    document.getElementById('modalTitle').textContent = 'Add NAT Rule';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">Chain</label>
            <select class="form-select" name="nat_chain" required>
                <option value="prerouting">PREROUTING (DNAT)</option>
                <option value="postrouting">POSTROUTING (SNAT/Masquerade)</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Source Network</label>
            <input type="text" class="form-control" name="source" placeholder="192.168.1.0/24 or any">
        </div>
        <div class="mb-3">
            <label class="form-label">Destination</label>
            <input type="text" class="form-control" name="destination" placeholder="any or specific IP">
        </div>
        <div class="mb-3">
            <label class="form-label">Interface</label>
            <input type="text" class="form-control" name="interface" placeholder="eth0, wlan0, etc.">
        </div>
        <div class="mb-3">
            <label class="form-label">Action</label>
            <select class="form-select" name="action" required>
                <option value="masquerade">Masquerade</option>
                <option value="snat">SNAT</option>
                <option value="dnat">DNAT</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Target (for SNAT/DNAT)</label>
            <input type="text" class="form-control" name="target" placeholder="IP address or port">
        </div>
    `;
    
    modal.show();
}

function applyTemplate(template) {
    fetch('/network/api/firewall/templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ template: template })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', `Template "${template}" applied successfully`, 'success');
            refreshFirewallRules();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to apply template', 'danger');
        console.error('Error:', error);
    });
}

function refreshFirewallRules() {
    // Reload the firewall rules table
    location.reload();
}

// Create chain form
document.getElementById('createChainForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    fetch('/network/api/firewall/chains', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', 'Chain created successfully', 'success');
            this.reset();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to create chain', 'danger');
        console.error('Error:', error);
    });
});
</script>
