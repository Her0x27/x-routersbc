{{define "content"}}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/network">Network</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Interfaces</li>
                    </ol>
                </nav>
                <h2 class="page-title">Network Interfaces</h2>
                <div class="text-muted mt-1">Manage physical, VLAN, and virtual network interfaces</div>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <a href="#" class="btn btn-outline-secondary" onclick="refreshInterfaces()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                        </svg>
                        Refresh
                    </a>
                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#interfaceModal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Interface
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <!-- Interface Tabs -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
                    <li class="nav-item">
                        <a href="#tabs-physical" class="nav-link active" data-bs-toggle="tab">Physical</a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-vlan" class="nav-link" data-bs-toggle="tab">VLAN</a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-vpn" class="nav-link" data-bs-toggle="tab">VPN</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Physical Interfaces -->
                    <div class="tab-pane active show" id="tabs-physical">
                        <div class="table-responsive">
                            <table class="table table-vcenter">
                                <thead>
                                    <tr>
                                        <th>Interface</th>
                                        <th>Status</th>
                                        <th>Type</th>
                                        <th>IP Address</th>
                                        <th>MAC Address</th>
                                        <th>Speed</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="physicalInterfaces">
                                    {{range .Interfaces}}
                                    {{if eq .Type "ethernet"}}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm me-2" style="background-image: url(/static/avatars/ethernet.jpg)"></span>
                                                <strong>{{.Name}}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            {{if .Enabled}}
                                            <span class="badge bg-success">Up</span>
                                            {{else}}
                                            <span class="badge bg-danger">Down</span>
                                            {{end}}
                                        </td>
                                        <td>{{.Type}}</td>
                                        <td><span class="text-muted">{{.Config}}</span></td>
                                        <td><code>00:00:00:00:00:00</code></td>
                                        <td>1000 Mbps</td>
                                        <td>
                                            <div class="btn-list flex-nowrap">
                                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="editInterface({{.ID}})">Edit</a>
                                                <a href="#" class="btn btn-sm btn-outline-danger" onclick="deleteInterface({{.ID}})">Delete</a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VLAN Interfaces -->
                    <div class="tab-pane" id="tabs-vlan">
                        <div class="table-responsive">
                            <table class="table table-vcenter">
                                <thead>
                                    <tr>
                                        <th>Interface</th>
                                        <th>Status</th>
                                        <th>VLAN ID</th>
                                        <th>Parent Interface</th>
                                        <th>IP Address</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vlanInterfaces">
                                    {{range .Interfaces}}
                                    {{if eq .Type "vlan"}}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm me-2" style="background-image: url(/static/avatars/vlan.jpg)"></span>
                                                <strong>{{.Name}}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            {{if .Enabled}}
                                            <span class="badge bg-success">Up</span>
                                            {{else}}
                                            <span class="badge bg-danger">Down</span>
                                            {{end}}
                                        </td>
                                        <td><span class="badge bg-blue">100</span></td>
                                        <td>eth0</td>
                                        <td><span class="text-muted">{{.Config}}</span></td>
                                        <td>
                                            <div class="btn-list flex-nowrap">
                                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="editInterface({{.ID}})">Edit</a>
                                                <a href="#" class="btn btn-sm btn-outline-danger" onclick="deleteInterface({{.ID}})">Delete</a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="#" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#interfaceModal" onclick="setInterfaceType('vlan')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add VLAN Interface
                            </a>
                        </div>
                    </div>

                    <!-- VPN Interfaces -->
                    <div class="tab-pane" id="tabs-vpn">
                        <div class="table-responsive">
                            <table class="table table-vcenter">
                                <thead>
                                    <tr>
                                        <th>Interface</th>
                                        <th>Status</th>
                                        <th>VPN Type</th>
                                        <th>Endpoint</th>
                                        <th>IP Address</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vpnInterfaces">
                                    {{range .Interfaces}}
                                    {{if or (eq .Type "vpn") (eq .Type "wireguard") (eq .Type "tunnel")}}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm me-2" style="background-image: url(/static/avatars/vpn.jpg)"></span>
                                                <strong>{{.Name}}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            {{if .Enabled}}
                                            <span class="badge bg-success">Connected</span>
                                            {{else}}
                                            <span class="badge bg-danger">Disconnected</span>
                                            {{end}}
                                        </td>
                                        <td>{{.Type}}</td>
                                        <td><span class="text-muted">Remote Server</span></td>
                                        <td><span class="text-muted">{{.Config}}</span></td>
                                        <td>
                                            <div class="btn-list flex-nowrap">
                                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="editInterface({{.ID}})">Edit</a>
                                                <a href="#" class="btn btn-sm btn-outline-danger" onclick="deleteInterface({{.ID}})">Delete</a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="#" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#interfaceModal" onclick="setInterfaceType('vpn')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add VPN Interface
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshInterfaces() {
    if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        window.ws.send(JSON.stringify({
            type: 'get_interfaces'
        }));
    }
}

function setInterfaceType(type) {
    const typeSelect = document.querySelector('#interfaceModal select[name="type"]');
    if (typeSelect) {
        typeSelect.value = type;
        typeSelect.dispatchEvent(new Event('change'));
    }
}

function editInterface(id) {
    // Load interface data and show modal
    fetch(`/network/api/interfaces/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Error', data.error, 'danger');
                return;
            }
            
            // Populate modal with interface data
            const form = document.getElementById('interfaceForm');
            form.elements.name.value = data.name || '';
            form.elements.type.value = data.type || '';
            form.elements.enabled.checked = data.enabled || false;
            
            // Set form action for update
            form.setAttribute('data-action', 'update');
            form.setAttribute('data-id', id);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('interfaceModal'));
            modal.show();
        })
        .catch(error => {
            showAlert('Error', 'Failed to load interface data', 'danger');
            console.error('Error:', error);
        });
}

function deleteInterface(id) {
    if (!confirm('Are you sure you want to delete this interface?')) {
        return;
    }
    
    fetch(`/network/api/interfaces/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', data.message, 'success');
            refreshInterfaces();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to delete interface', 'danger');
        console.error('Error:', error);
    });
}

// Handle interface form submission
document.getElementById('interfaceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (key === 'enabled') {
            data[key] = this.elements[key].checked;
        } else {
            data[key] = value;
        }
    }
    
    const action = this.getAttribute('data-action');
    const id = this.getAttribute('data-id');
    
    let url = '/network/api/interfaces';
    let method = 'POST';
    
    if (action === 'update' && id) {
        url += `/${id}`;
        method = 'PUT';
    }
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', data.message, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('interfaceModal'));
            modal.hide();
            
            // Reset form
            this.reset();
            this.removeAttribute('data-action');
            this.removeAttribute('data-id');
            
            // Refresh interfaces
            refreshInterfaces();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to save interface', 'danger');
        console.error('Error:', error);
    });
});

// Handle interface type change
document.querySelector('#interfaceModal select[name="type"]').addEventListener('change', function() {
    const typeConfig = document.getElementById('typeSpecificConfig');
    const type = this.value;
    
    // Clear previous config
    typeConfig.innerHTML = '';
    
    if (type === 'vlan') {
        typeConfig.innerHTML = `
            <div class="row">
                <div class="col-lg-6">
                    <div class="mb-3">
                        <label class="form-label">VLAN ID</label>
                        <input type="number" class="form-control" name="vlan_id" min="1" max="4094" required>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="mb-3">
                        <label class="form-label">Parent Interface</label>
                        <select class="form-select" name="parent_interface" required>
                            <option value="">Select parent...</option>
                            <option value="eth0">eth0</option>
                            <option value="eth1">eth1</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    } else if (type === 'bridge') {
        typeConfig.innerHTML = `
            <div class="mb-3">
                <label class="form-label">Bridge Interfaces</label>
                <select class="form-select" name="bridge_interfaces" multiple>
                    <option value="eth0">eth0</option>
                    <option value="eth1">eth1</option>
                    <option value="wlan0">wlan0</option>
                </select>
                <small class="form-hint">Select interfaces to bridge together</small>
            </div>
        `;
    }
});

// Handle IP method change
document.querySelector('#interfaceModal select[name="ip_method"]').addEventListener('change', function() {
    const staticConfig = document.getElementById('staticIpConfig');
    
    if (this.value === 'static') {
        staticConfig.style.display = 'block';
        // Make fields required
        staticConfig.querySelectorAll('input').forEach(input => {
            if (input.name === 'ip_address' || input.name === 'netmask') {
                input.required = true;
            }
        });
    } else {
        staticConfig.style.display = 'none';
        // Remove required attribute
        staticConfig.querySelectorAll('input').forEach(input => {
            input.required = false;
        });
    }
});
</script>
{{end}}

{{template "layout.html" .}}
