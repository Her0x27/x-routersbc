{{define "content"}}
<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/network">Network</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Routing</li>
                    </ol>
                </nav>
                <h2 class="page-title">
                    Routing Configuration
                </h2>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#route-modal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Route
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <!-- Tabs -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a href="#tabs-static-routes" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <circle cx="6" cy="19" r="2"/>
                                <circle cx="18" cy="5" r="2"/>
                                <path d="m8 19l8 0"/>
                                <path d="m16 5l-8 0"/>
                                <path d="m12 5v14"/>
                            </svg>
                            Static Routes
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a href="#tabs-upnp" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M9 12l-4 -4l4 -4"/>
                                <path d="M15 12l4 -4l-4 -4"/>
                                <path d="M12 3v18"/>
                            </svg>
                            UPnP IGD & PCP
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Static Routes Tab -->
                    <div class="tab-pane active show" id="tabs-static-routes" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table">
                                <thead>
                                    <tr>
                                        <th>Destination</th>
                                        <th>Gateway</th>
                                        <th>Interface</th>
                                        <th>Metric</th>
                                        <th>Status</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="static-routes">
                                    {{if .routes}}
                                        {{range .routes}}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div>
                                                        <strong>{{.Destination}}</strong>
                                                        {{if .Netmask}}<small class="text-muted d-block">{{.Netmask}}</small>{{end}}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{if .Gateway}}{{.Gateway}}{{else}}-{{end}}</td>
                                            <td>
                                                <span class="badge bg-blue">{{.Interface}}</span>
                                            </td>
                                            <td>{{.Metric}}</td>
                                            <td>
                                                <span class="status status-green">
                                                    <span class="status-dot status-dot-animated"></span>
                                                    Active
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-list flex-nowrap">
                                                    <button class="btn btn-white btn-sm" onclick="editRoute({{.ID}})">Edit</button>
                                                    <button class="btn btn-white btn-sm" onclick="deleteRoute({{.ID}})">Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {{end}}
                                    {{else}}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Loading routes...</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Current Routing Table -->
                        <div class="mt-4">
                            <h4>Current Routing Table</h4>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Destination</th>
                                            <th>Gateway</th>
                                            <th>Genmask</th>
                                            <th>Flags</th>
                                            <th>Metric</th>
                                            <th>Interface</th>
                                        </tr>
                                    </thead>
                                    <tbody id="routing-table">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">Loading routing table...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- UPnP IGD & PCP Tab -->
                    <div class="tab-pane" id="tabs-upnp" role="tabpanel">
                        <form id="upnp-form">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-check form-switch form-check-lg">
                                        <input class="form-check-input" type="checkbox" name="upnp_enabled" id="upnp-enabled">
                                        <span class="form-check-label form-check-label-lg">Enable UPnP IGD Port Mapping Service</span>
                                    </label>
                                    <small class="form-hint">Allows devices to automatically configure port forwarding</small>
                                </div>
                            </div>
                            
                            <div id="upnp-config" class="d-none">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="pcp_enabled">
                                            <span class="form-check-label">Allow PCP/NAT-PMP Port Mapping</span>
                                        </label>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="stun_enabled">
                                            <span class="form-check-label">Enable STUN</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">External Interface</label>
                                        <select class="form-select" name="external_interface">
                                            <option value="">Select WAN interface...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Internal Subnet</label>
                                        <input type="text" class="form-control" name="internal_subnet" value="192.168.1.0/24" placeholder="192.168.1.0/24">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" name="traffic_shaping">
                                            <span class="form-check-label">Enable Traffic Shaping</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="traffic-shaping-config" class="d-none">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Upload Bandwidth</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" name="upload_bandwidth" placeholder="1000">
                                                <span class="input-group-text">kbps</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Download Bandwidth</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" name="download_bandwidth" placeholder="10000">
                                                <span class="input-group-text">kbps</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- STUN Servers -->
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">STUN Servers</label>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addStunServer()">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                                </svg>
                                                Add STUN Server
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Server</th>
                                                        <th>Port</th>
                                                        <th>Protocol</th>
                                                        <th class="w-1">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="stun-servers">
                                                    <tr>
                                                        <td>stun.l.google.com</td>
                                                        <td>19302</td>
                                                        <td>UDP</td>
                                                        <td>
                                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeStunServer(this)">Remove</button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Port Mappings -->
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h4>Active Port Mappings</h4>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Protocol</th>
                                                        <th>External Port</th>
                                                        <th>Internal IP</th>
                                                        <th>Internal Port</th>
                                                        <th>Description</th>
                                                        <th>Lease Time</th>
                                                        <th class="w-1">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="port-mappings">
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted">No active port mappings</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">Save UPnP Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle UPnP toggle
document.getElementById('upnp-enabled').addEventListener('change', function() {
    const config = document.getElementById('upnp-config');
    if (this.checked) {
        config.classList.remove('d-none');
        loadUPnPConfig();
    } else {
        config.classList.add('d-none');
    }
});

// Handle traffic shaping toggle
document.querySelector('input[name="traffic_shaping"]').addEventListener('change', function() {
    const config = document.getElementById('traffic-shaping-config');
    if (this.checked) {
        config.classList.remove('d-none');
    } else {
        config.classList.add('d-none');
    }
});

function loadUPnPConfig() {
    // Load available interfaces for UPnP
    fetch('/api/network/interfaces')
        .then(response => response.json())
        .then(interfaces => {
            const select = document.querySelector('select[name="external_interface"]');
            select.innerHTML = '<option value="">Select WAN interface...</option>';
            
            interfaces.filter(iface => iface.type === 'ethernet' || iface.type === 'wireless').forEach(iface => {
                const option = document.createElement('option');
                option.value = iface.name;
                option.textContent = `${iface.name} (${iface.ip_address || 'No IP'})`;
                select.appendChild(option);
            });
        });
}

function loadRoutingTable() {
    fetch('/api/network/routing/table')
        .then(response => response.json())
        .then(routes => {
            const tbody = document.getElementById('routing-table');
            tbody.innerHTML = '';
            
            if (routes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No routes in table</td></tr>';
                return;
            }
            
            routes.forEach(route => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${route.destination}</td>
                    <td>${route.gateway || '*'}</td>
                    <td>${route.genmask || '0.0.0.0'}</td>
                    <td>${route.flags || 'U'}</td>
                    <td>${route.metric || '0'}</td>
                    <td>${route.interface}</td>
                `;
            });
        })
        .catch(error => {
            console.error('Error loading routing table:', error);
            document.getElementById('routing-table').innerHTML = 
                '<tr><td colspan="6" class="text-center text-muted text-red">Error loading routing table</td></tr>';
        });
}

function addStunServer() {
    const server = prompt('Enter STUN server address:');
    const port = prompt('Enter port:', '19302');
    const protocol = prompt('Enter protocol (UDP/TCP):', 'UDP');
    
    if (server && port && protocol) {
        const tbody = document.getElementById('stun-servers');
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${server}</td>
            <td>${port}</td>
            <td>${protocol}</td>
            <td>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeStunServer(this)">Remove</button>
            </td>
        `;
    }
}

function removeStunServer(button) {
    if (confirm('Are you sure you want to remove this STUN server?')) {
        button.closest('tr').remove();
    }
}

function editRoute(routeId) {
    // Load route data and populate modal
    fetch(`/api/network/routing/routes/${routeId}`)
        .then(response => response.json())
        .then(route => {
            const modal = new bootstrap.Modal(document.getElementById('route-modal'));
            const form = document.getElementById('route-form');
            
            form.elements['destination'].value = route.destination;
            form.elements['netmask'].value = route.netmask;
            form.elements['gateway'].value = route.gateway;
            form.elements['metric'].value = route.metric;
            
            // Load available interfaces
            fetch('/api/network/interfaces')
                .then(response => response.json())
                .then(interfaces => {
                    const select = form.elements['interface'];
                    select.innerHTML = '<option value="">Select interface...</option>';
                    interfaces.forEach(iface => {
                        const option = document.createElement('option');
                        option.value = iface.name;
                        option.textContent = iface.name;
                        if (iface.name === route.interface) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                });
            
            modal.show();
        })
        .catch(error => {
            alert('Error loading route: ' + error);
        });
}

function deleteRoute(routeId) {
    if (confirm('Are you sure you want to delete this route?')) {
        fetch(`/api/network/routing/routes/${routeId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                location.reload();
            }
        })
        .catch(error => alert('Error deleting route: ' + error));
    }
}

// Handle route form submission
document.getElementById('route-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/network/routing/routes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            bootstrap.Modal.getInstance(document.getElementById('route-modal')).hide();
            location.reload();
        }
    })
    .catch(error => alert('Error saving route: ' + error));
});

// Handle UPnP form submission
document.getElementById('upnp-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Collect STUN servers
    const stunServers = [];
    document.querySelectorAll('#stun-servers tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 3) {
            stunServers.push({
                server: cells[0].textContent,
                port: cells[1].textContent,
                protocol: cells[2].textContent
            });
        }
    });
    data.stun_servers = stunServers;
    
    fetch('/api/network/routing/upnp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('UPnP configuration saved successfully');
        }
    })
    .catch(error => alert('Error saving UPnP configuration: ' + error));
});

// Load routing table on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRoutingTable();
    
    // Load available interfaces for route modal
    fetch('/api/network/interfaces')
        .then(response => response.json())
        .then(interfaces => {
            const select = document.querySelector('#route-modal select[name="interface"]');
            if (select) {
                select.innerHTML = '<option value="">Select interface...</option>';
                interfaces.forEach(iface => {
                    const option = document.createElement('option');
                    option.value = iface.name;
                    option.textContent = iface.name;
                    select.appendChild(option);
                });
            }
        });
});
</script>
{{end}}
{{template "base/layout.html" .}}
