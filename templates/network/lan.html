{{define "content"}}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/network">Network</a></li>
                        <li class="breadcrumb-item active" aria-current="page">LAN</li>
                    </ol>
                </nav>
                <h2 class="page-title">LAN Configuration</h2>
                <div class="text-muted mt-1">Configure DHCP server, DNS settings, and bridge configuration</div>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <a href="#" class="btn btn-outline-secondary" onclick="refreshLANStatus()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                        </svg>
                        Refresh Status
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <!-- LAN Status -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Current LAN Status</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="text-muted">LAN IP Address</div>
                                <div class="h3" id="lanIPAddress">{{if .LANConfig.Config.ip}}{{.LANConfig.Config.ip}}{{else}}192.168.1.1{{end}}</div>
                            </div>
                            <div class="col-lg-3">
                                <div class="text-muted">DHCP Status</div>
                                <div class="h3">
                                    {{if .LANConfig.DHCPEnabled}}
                                    <span class="badge bg-success">Enabled</span>
                                    {{else}}
                                    <span class="badge bg-secondary">Disabled</span>
                                    {{end}}
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="text-muted">DNS Mode</div>
                                <div class="h3" id="dnsMode">{{.LANConfig.DNSMode}}</div>
                            </div>
                            <div class="col-lg-3">
                                <div class="text-muted">Active Clients</div>
                                <div class="h3" id="activeClients">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LAN Configuration Tabs -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
                    <li class="nav-item">
                        <a href="#tabs-dhcp" class="nav-link active" data-bs-toggle="tab">DHCP Server</a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-dns" class="nav-link" data-bs-toggle="tab">DNS Settings</a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-bridge" class="nav-link" data-bs-toggle="tab">Bridge Settings</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- DHCP Configuration -->
                    <div class="tab-pane active show" id="tabs-dhcp">
                        <form id="dhcpConfigForm">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label class="form-label">DHCP Mode</label>
                                        <select class="form-select" name="dhcp_mode" required>
                                            <option value="disabled" {{if not .LANConfig.DHCPEnabled}}selected{{end}}>Disabled</option>
                                            <option value="server" {{if and .LANConfig.DHCPEnabled (eq .LANConfig.DHCPMode "server")}}selected{{end}}>DHCP Server</option>
                                            <option value="relay" {{if and .LANConfig.DHCPEnabled (eq .LANConfig.DHCPMode "relay")}}selected{{end}}>DHCP Relay</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label class="form-label">LAN Interface</label>
                                        <select class="form-select" name="lan_interface">
                                            <option value="br0">br0 (Bridge)</option>
                                            <option value="eth0">eth0</option>
                                            <option value="eth1">eth1</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div id="dhcpServerConfig">
                                <h4>DHCP Server Configuration</h4>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">IP Range Start</label>
                                            <input type="text" class="form-control" name="dhcp_start" placeholder="192.168.1.100" value="{{if .LANConfig.Config.dhcp.range_start}}{{.LANConfig.Config.dhcp.range_start}}{{end}}">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">IP Range End</label>
                                            <input type="text" class="form-control" name="dhcp_end" placeholder="192.168.1.200" value="{{if .LANConfig.Config.dhcp.range_end}}{{.LANConfig.Config.dhcp.range_end}}{{end}}">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">Subnet Mask</label>
                                            <input type="text" class="form-control" name="dhcp_netmask" placeholder="255.255.255.0" value="{{if .LANConfig.Config.dhcp.netmask}}{{.LANConfig.Config.dhcp.netmask}}{{else}}255.255.255.0{{end}}">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">Gateway</label>
                                            <input type="text" class="form-control" name="dhcp_gateway" placeholder="192.168.1.1" value="{{if .LANConfig.Config.dhcp.gateway}}{{.LANConfig.Config.dhcp.gateway}}{{end}}">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">Lease Time</label>
                                            <select class="form-select" name="lease_time">
                                                <option value="3600">1 Hour</option>
                                                <option value="21600">6 Hours</option>
                                                <option value="43200">12 Hours</option>
                                                <option value="86400" selected>24 Hours</option>
                                                <option value="604800">7 Days</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">DNS Servers</label>
                                            <input type="text" class="form-control" name="dhcp_dns" placeholder="8.8.8.8, 8.8.4.4" value="{{if .LANConfig.Config.dhcp.dns}}{{range $i, $dns := .LANConfig.Config.dhcp.dns}}{{if $i}}, {{end}}{{$dns}}{{end}}{{end}}">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="dhcpRelayConfig" style="display: none;">
                                <h4>DHCP Relay Configuration</h4>
                                <div class="mb-3">
                                    <label class="form-label">DHCP Server IP</label>
                                    <input type="text" class="form-control" name="relay_server" placeholder="192.168.0.1">
                                    <small class="form-hint">IP address of the DHCP server to relay requests to</small>
                                </div>
                            </div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">Save DHCP Configuration</button>
                            </div>
                        </form>

                        <!-- DHCP Leases -->
                        <div class="mt-4">
                            <h4>Active DHCP Leases</h4>
                            <div class="table-responsive">
                                <table class="table table-vcenter">
                                    <thead>
                                        <tr>
                                            <th>IP Address</th>
                                            <th>MAC Address</th>
                                            <th>Hostname</th>
                                            <th>Expires</th>
                                            <th class="w-1">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dhcpLeasesTable">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Static DHCP Reservations -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Static DHCP Reservations</h4>
                                <button type="button" class="btn btn-primary" onclick="addStaticReservation()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Add Reservation
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-vcenter">
                                    <thead>
                                        <tr>
                                            <th>MAC Address</th>
                                            <th>IP Address</th>
                                            <th>Hostname</th>
                                            <th class="w-1">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staticReservationsTable">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- DNS Configuration -->
                    <div class="tab-pane" id="tabs-dns">
                        <form id="dnsConfigForm">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label class="form-label">DNS Mode</label>
                                        <select class="form-select" name="dns_mode" required>
                                            <option value="direct" {{if eq .LANConfig.DNSMode "direct"}}selected{{end}}>Direct ISP</option>
                                            <option value="proxy" {{if eq .LANConfig.DNSMode "proxy"}}selected{{end}}>DNS Proxy</option>
                                            <option value="forward" {{if eq .LANConfig.DNSMode "forward"}}selected{{end}}>DNS Forwarder</option>
                                            <option value="server" {{if eq .LANConfig.DNSMode "server"}}selected{{end}}>DNS Server</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label class="form-label">DNS Security</label>
                                        <select class="form-select" name="dns_security">
                                            <option value="none">No Secure DNS</option>
                                            <option value="dot">DNS over TLS (DoT)</option>
                                            <option value="doh">DNS over HTTPS (DoH)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Upstream DNS Servers</label>
                                <textarea class="form-control" name="dns_servers" rows="3" placeholder="8.8.8.8&#10;8.8.4.4&#10;1.1.1.1">{{if .LANConfig.Config.dns.servers}}{{range .LANConfig.Config.dns.servers}}{{.}}
{{end}}{{end}}</textarea>
                                <small class="form-hint">One server per line. Supports IP addresses and DoH/DoT URLs</small>
                            </div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">Save DNS Configuration</button>
                            </div>
                        </form>

                        <!-- DNS Local Zones -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Local DNS Zones</h4>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#dnsZoneModal">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Add Zone
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-vcenter">
                                    <thead>
                                        <tr>
                                            <th>Zone/Domain</th>
                                            <th>Type</th>
                                            <th>Value</th>
                                            <th>Status</th>
                                            <th class="w-1">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dnsZonesTable">
                                        <!-- Default local zone -->
                                        <tr>
                                            <td><code>router.local</code></td>
                                            <td><span class="badge bg-blue">A</span></td>
                                            <td>192.168.1.1</td>
                                            <td><span class="badge bg-success">Enabled</span></td>
                                            <td>
                                                <div class="btn-list flex-nowrap">
                                                    <a href="#" class="btn btn-sm btn-outline-primary">Edit</a>
                                                    <a href="#" class="btn btn-sm btn-outline-danger">Delete</a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- DNS Routing -->
                        <div class="mt-4">
                            <h4>DNS Geo Routing</h4>
                            <div class="table-responsive">
                                <table class="table table-vcenter">
                                    <thead>
                                        <tr>
                                            <th>Domain/Zone</th>
                                            <th>Target</th>
                                            <th>Action</th>
                                            <th>Status</th>
                                            <th class="w-1">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>*.ru</code></td>
                                            <td>Direct</td>
                                            <td><span class="badge bg-green">Allow</span></td>
                                            <td><span class="badge bg-success">Enabled</span></td>
                                            <td>
                                                <div class="btn-list flex-nowrap">
                                                    <a href="#" class="btn btn-sm btn-outline-primary">Edit</a>
                                                    <a href="#" class="btn btn-sm btn-outline-danger">Delete</a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Bridge Configuration -->
                    <div class="tab-pane" id="tabs-bridge">
                        <form id="bridgeConfigForm">
                            <div class="mb-3">
                                <label class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bridge_enabled" {{if .LANConfig.BridgeEnabled}}checked{{end}}>
                                    <span class="form-check-label">Enable Bridge Mode</span>
                                </label>
                                <small class="form-hint">Bridge multiple interfaces together for LAN connectivity</small>
                            </div>

                            <div id="bridgeSettings" {{if not .LANConfig.BridgeEnabled}}style="display: none;"{{end}}>
                                <div class="mb-3">
                                    <label class="form-label">Bridge Name</label>
                                    <input type="text" class="form-control" name="bridge_name" value="br0" placeholder="br0">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Bridge Interfaces</label>
                                    <div class="form-selectgroup">
                                        <label class="form-selectgroup-item">
                                            <input type="checkbox" name="bridge_interfaces" value="eth0" class="form-selectgroup-input" checked>
                                            <span class="form-selectgroup-label">eth0</span>
                                        </label>
                                        <label class="form-selectgroup-item">
                                            <input type="checkbox" name="bridge_interfaces" value="eth1" class="form-selectgroup-input">
                                            <span class="form-selectgroup-label">eth1</span>
                                        </label>
                                        <label class="form-selectgroup-item">
                                            <input type="checkbox" name="bridge_interfaces" value="wlan0" class="form-selectgroup-input">
                                            <span class="form-selectgroup-label">wlan0</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">STP (Spanning Tree Protocol)</label>
                                            <select class="form-select" name="stp_enabled">
                                                <option value="0">Disabled</option>
                                                <option value="1">Enabled</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">Forward Delay</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" name="forward_delay" value="15" min="4" max="30">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hello Time</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" name="hello_time" value="2" min="1" max="10">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label class="form-label">Max Age</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" name="max_age" value="20" min="6" max="40">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">Save Bridge Configuration</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle DHCP mode changes
document.querySelector('select[name="dhcp_mode"]').addEventListener('change', function() {
    const serverConfig = document.getElementById('dhcpServerConfig');
    const relayConfig = document.getElementById('dhcpRelayConfig');
    
    serverConfig.style.display = 'none';
    relayConfig.style.display = 'none';
    
    if (this.value === 'server') {
        serverConfig.style.display = 'block';
    } else if (this.value === 'relay') {
        relayConfig.style.display = 'block';
    }
});

// Handle bridge enable/disable
document.querySelector('input[name="bridge_enabled"]').addEventListener('change', function() {
    const bridgeSettings = document.getElementById('bridgeSettings');
    bridgeSettings.style.display = this.checked ? 'block' : 'none';
});

// DHCP configuration form
document.getElementById('dhcpConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    fetch('/network/api/lan/dhcp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', 'DHCP configuration saved successfully', 'success');
            refreshLANStatus();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to save DHCP configuration', 'danger');
        console.error('Error:', error);
    });
});

// DNS configuration form
document.getElementById('dnsConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Parse DNS servers
    if (data.dns_servers) {
        data.dns_servers = data.dns_servers.split('\n').filter(s => s.trim());
    }
    
    fetch('/network/api/lan/dns', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', 'DNS configuration saved successfully', 'success');
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to save DNS configuration', 'danger');
        console.error('Error:', error);
    });
});

// Bridge configuration form
document.getElementById('bridgeConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // Handle checkboxes
    data.bridge_enabled = this.elements.bridge_enabled.checked;
    data.bridge_interfaces = [];
    
    const bridgeInterfaces = this.querySelectorAll('input[name="bridge_interfaces"]:checked');
    bridgeInterfaces.forEach(input => {
        data.bridge_interfaces.push(input.value);
    });
    
    // Other form fields
    data.bridge_name = this.elements.bridge_name.value;
    data.stp_enabled = this.elements.stp_enabled.value;
    data.forward_delay = this.elements.forward_delay.value;
    data.hello_time = this.elements.hello_time.value;
    data.max_age = this.elements.max_age.value;
    
    fetch('/network/api/lan/bridge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', 'Bridge configuration saved successfully', 'success');
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to save bridge configuration', 'danger');
        console.error('Error:', error);
    });
});

function refreshLANStatus() {
    if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        window.ws.send(JSON.stringify({
            type: 'get_lan_status'
        }));
    }
}

function addStaticReservation() {
    // This would open a modal for adding static DHCP reservations
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('genericModal'));
    
    document.getElementById('modalTitle').textContent = 'Add Static DHCP Reservation';
    document.getElementById('modalBody').innerHTML = `
        <div class="mb-3">
            <label class="form-label">MAC Address</label>
            <input type="text" class="form-control" name="mac_address" placeholder="00:11:22:33:44:55" required>
        </div>
        <div class="mb-3">
            <label class="form-label">IP Address</label>
            <input type="text" class="form-control" name="ip_address" placeholder="192.168.1.50" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Hostname (Optional)</label>
            <input type="text" class="form-control" name="hostname" placeholder="my-device">
        </div>
    `;
    
    modal.show();
}

function loadDHCPLeases() {
    fetch('/network/api/lan/dhcp/leases')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('dhcpLeasesTable');
            tbody.innerHTML = '';
            
            if (data.leases && data.leases.length > 0) {
                data.leases.forEach(lease => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><code>${lease.ip}</code></td>
                        <td><code>${lease.mac}</code></td>
                        <td>${lease.hostname || '-'}</td>
                        <td>${lease.expires || 'Never'}</td>
                        <td>
                            <a href="#" class="btn btn-sm btn-outline-primary" onclick="makeStatic('${lease.mac}', '${lease.ip}', '${lease.hostname}')">Make Static</a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No active leases</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading DHCP leases:', error);
        });
}

function makeStatic(mac, ip, hostname) {
    const data = {
        mac_address: mac,
        ip_address: ip,
        hostname: hostname
    };
    
    fetch('/network/api/lan/dhcp/static', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error', data.error, 'danger');
        } else {
            showAlert('Success', 'Static reservation created successfully', 'success');
            loadDHCPLeases();
        }
    })
    .catch(error => {
        showAlert('Error', 'Failed to create static reservation', 'danger');
        console.error('Error:', error);
    });
}

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    // Set initial DHCP mode display
    const dhcpMode = document.querySelector('select[name="dhcp_mode"]').value;
    if (dhcpMode) {
        document.querySelector('select[name="dhcp_mode"]').dispatchEvent(new Event('change'));
    }
    
    // Load DHCP leases
    loadDHCPLeases();
    
    // Set up periodic refresh
    setInterval(loadDHCPLeases, 30000); // Refresh every 30 seconds
});
</script>
{{end}}

{{template "layout.html" .}}
